import pandas as pd

# Load input files
condition_df = pd.read_csv("../data/processed_data/road_condition_categorized.csv")

erosion_df = pd.read_csv("../data/processed_data/average_erosion_score_per_road.csv")[["road", "avg_erosion_score"]]
flood_df = pd.read_csv("../data/processed_data/road_flood_scores.csv")[["road", "avg_flood_score"]]
earthquake_df = pd.read_csv("../data/processed_data/avg_earthquake_score.csv")

# Convert avg_erosion_score to numeric and report non-numeric entries
erosion_df["avg_erosion_score"] = pd.to_numeric(erosion_df["avg_erosion_score"], errors="coerce")



# Merge all on 'road' column
merged_df = condition_df.merge(erosion_df, on="road", how="left")
merged_df = merged_df.merge(flood_df, on="road", how="left")
merged_df = merged_df.merge(earthquake_df, on="road", how="left")


print(f"Rows after merging: {len(merged_df)}") #check nothing is lost



# Preview merged result
print(merged_df)

#save input file
output_path = "../data/processed_data/input_road_vulnerability.csv"
merged_df.to_csv(output_path, index=False)
 
# Do the same for the bridges
# Load input files
bridge_flood_df = pd.read_csv("../data/processed_data/avg_bridge_flood_scores.csv")[["LRPName", "avg_flood_score"]]
bridge_erosion_df = pd.read_csv("../data/processed_data/avg_bridge_rivererosion_score.csv")[["LRPName", "avg_erosion_score"]]
bridge_earthquake_df = pd.read_csv("../data/processed_data/avg_bridge_earthquake_score.csv")[["LRPName", "avg_earthquake_score"]]

# Merge all on 'LRPName' column
bridge_merged_df = bridge_flood_df.merge(bridge_erosion_df, on="LRPName", how="left")
bridge_merged_df = bridge_merged_df.merge(bridge_earthquake_df, on="LRPName", how="left")

# Calculate the overall vulnerability score as the average of the three scores
bridge_merged_df["vulnerability_score"] = bridge_merged_df[["avg_flood_score", "avg_erosion_score", "avg_earthquake_score"]].mean(axis=1)

# Save the merged result to a CSV file
output_path_bridges = "../data/processed_data/input_bridge_vulnerability.csv"
bridge_merged_df.to_csv(output_path_bridges, index=False)

print(f"The merged bridge vulnerability scores have been saved to '{output_path}'.")